<!doctype html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Galactic Trial</title>
<style>
*{box-sizing:border-box}
html,body{margin:0;width:100%;height:100%;overflow:hidden;touch-action:none;background:#04070d;color:#eef4ff;font-family:Trebuchet MS,Segoe UI,sans-serif}
#game{position:fixed;inset:0;width:100vw;height:100vh;display:block}
#hud{position:fixed;top:max(10px,env(safe-area-inset-top));left:max(10px,env(safe-area-inset-left));right:max(10px,env(safe-area-inset-right));z-index:8;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-radius:14px;background:linear-gradient(135deg,rgba(5,10,18,.76),rgba(18,34,52,.56));border:1px solid rgba(180,220,255,.26)}
#title{font-weight:900;letter-spacing:.08em}
#stats{font-weight:700;display:flex;gap:12px;align-items:center}
.mini{height:34px;padding:0 12px;border-radius:6px;border:1px solid rgba(210,171,84,.74);background:linear-gradient(180deg,rgba(38,32,18,.86),rgba(19,16,10,.92));color:#f7d890;font-weight:900;font-size:12px;letter-spacing:.04em}
.mini.off{opacity:.72}
#cheat{position:fixed;top:max(58px,calc(16px + env(safe-area-inset-top)));left:50%;transform:translateX(-50%);z-index:9;padding:8px 14px;border-radius:10px;border:1px solid rgba(255,220,120,.65);background:rgba(75,45,10,.72);font-weight:900;display:none}
#msg{position:fixed;top:max(98px,calc(60px + env(safe-area-inset-top)));left:50%;transform:translateX(-50%);z-index:9;padding:8px 14px;border-radius:10px;border:1px solid rgba(160,220,255,.65);background:rgba(10,28,44,.82);font-weight:900;opacity:0;transition:opacity .2s}
#msg.show{opacity:1}
#controls{position:fixed;z-index:10;left:max(10px,env(safe-area-inset-left));right:max(10px,env(safe-area-inset-right));bottom:max(10px,env(safe-area-inset-bottom));display:flex;justify-content:space-between;pointer-events:none}
.pad{display:flex;gap:10px;pointer-events:auto}
.b{width:78px;height:78px;border-radius:18px;border:1px solid rgba(210,230,255,.44);background:linear-gradient(165deg,rgba(16,27,41,.9),rgba(10,18,28,.82));color:#fff;font-weight:900;font-size:22px}
.b:active,.b.on{transform:translateY(2px) scale(.98)}
#rotate{position:fixed;inset:0;display:none;z-index:30;place-items:center;text-align:center;padding:24px;background:rgba(2,6,10,.95);font-size:6vw;font-weight:900}
.overlay{position:fixed;inset:0;z-index:20;display:none;place-items:center;background:rgba(2,4,10,.72)}
.overlay.show{display:grid}
.panel{min-width:min(92vw,620px);padding:26px 24px;border-radius:16px;background:linear-gradient(155deg,rgba(9,17,30,.95),rgba(18,29,44,.92));border:1px solid rgba(188,224,255,.3);text-align:center}
.panel h1,.panel h2{margin:0 0 10px}
.panel p{margin:0 0 14px;opacity:.9}
#menu{z-index:45;grid-template-columns:minmax(280px,1fr) minmax(340px,460px);gap:24px;align-items:center;padding:28px;position:fixed;overflow:hidden;background:radial-gradient(circle at 22% 24%,rgba(62,103,170,.28) 0%,rgba(16,38,84,.08) 36%,rgba(4,11,24,.92) 100%)}
#menu::before{content:'';position:absolute;inset:-4%;background:url('assets/ui/zv.png') center/cover no-repeat;animation:deathZoom 9s ease-in-out infinite alternate;z-index:0;transform-origin:center center}
#menu::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(6,14,28,.35),rgba(4,10,20,.7));z-index:1}
#menu>div{position:relative;z-index:2}
#menu .panel{justify-self:end;width:min(100%,460px);padding:18px 20px;border-radius:10px;background:linear-gradient(180deg,rgba(8,10,14,.78),rgba(5,8,12,.82));border:1px solid rgba(213,171,87,.75);box-shadow:0 0 26px rgba(0,0,0,.55),inset 0 0 0 1px rgba(229,208,146,.16);text-align:left}
#menuTitle{font-size:42px;letter-spacing:.08em;line-height:1;color:#e8edf8;text-shadow:0 2px 12px rgba(0,0,0,.5)}
#menuSubtitle{font-size:13px;color:#d9e8ff;opacity:.9;line-height:1.45}
#testReport{font-size:12px;color:#e4cb8a;letter-spacing:.03em;text-align:center;margin-top:10px}
.menu-row{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.menu-btn{height:40px;width:100%;padding:0 16px;border-radius:3px;border:1px solid rgba(210,171,84,.74);font-size:13px;font-weight:900;color:#f7d890;background:linear-gradient(180deg,rgba(38,32,18,.86),rgba(19,16,10,.92));letter-spacing:.05em;text-align:left}
.menu-btn.primary{color:#f7d890;border-color:rgba(210,171,84,.74);background:linear-gradient(180deg,rgba(38,32,18,.86),rgba(19,16,10,.92));box-shadow:none}
.menu-btn.off{opacity:.74}
.menu-select{height:40px;width:100%;padding:0 12px;border-radius:3px;border:1px solid rgba(210,171,84,.74);background:linear-gradient(180deg,rgba(20,18,14,.9),rgba(12,11,9,.94));color:#f7d890;font-size:12px;font-weight:700}
@media (max-width:960px){#menu{grid-template-columns:1fr;padding:16px}#menu .panel{justify-self:center;width:min(100%,520px)}}
@keyframes deathZoom{from{transform:scale(1)}to{transform:scale(1.09)}}
@media (orientation:portrait){#rotate{display:grid}#game,#hud,#controls,#cheat,#msg,.overlay{filter:blur(2px) brightness(.7)}}
</style>
</head>
<body>
<div id="rotate">Переверни телефон в горизонтальный режим</div>
<div id="hud"><span id="title">GALACTIC TRIAL</span><span id="stats"><span id="level">Уровень 1/50</span><span id="deaths">Смерти: 0</span><span id="time">Время: 0.0с</span><button id="homeBtn" class="mini">ДОМОЙ</button><button id="musicBtn" class="mini">МУЗЫКА: ВКЛ</button></span></div>
<div id="cheat">ВЫ ПОД ЧИТКОДОМ</div>
<div id="msg"></div>
<canvas id="game"></canvas>
<div id="controls"><div class="pad"><button id="l" class="b">◀</button><button id="r" class="b">▶</button></div><div class="pad"><button id="j" class="b">J</button><button id="d" class="b">D</button></div></div>
<div id="menu" class="overlay show"><div></div><div class="panel"><h1 id="menuTitle">GALACTIC TRIAL</h1><p id="menuSubtitle">Операция в глубоком космосе. 50 уровней, вертикальные штурмы и финальный прорыв налево.</p><p id="testReport">Pathfinder тест: не запускался</p><div class="menu-row"><button id="playBtn" class="menu-btn primary">ИГРАТЬ</button><button id="aiPlayBtn" class="menu-btn">ИИ ДЕМО</button><button id="menuSoundBtn" class="menu-btn">ЗВУК: ВКЛ</button></div><div class="menu-row"><button id="customLoadBtn" class="menu-btn">ЗАГРУЗИТЬ КАСТОМНЫЕ УРОВНИ</button><select id="customSelect" class="menu-select"><option value="">Нет загруженных</option></select><button id="customPlayBtn" class="menu-btn">ТЕСТ ВЫБРАННОГО УРОВНЯ</button></div></div></div>
<input id="customFilesInput" type="file" accept=".json,application/json" multiple style="display:none" />
<div id="win" class="overlay"><div class="panel"><h2>Все 50 уровней пройдены</h2><p id="res"></p><div class="menu-row"><button id="retry" class="menu-btn primary">ЕЩЕ РАЗ</button></div></div></div>
<script src="assets/music/music-inline.js"></script>
<script>
const cv = document.getElementById('game');
const cx = cv.getContext('2d', {alpha:false});
const levelEl = document.getElementById('level');
const deathsEl = document.getElementById('deaths');
const timeEl = document.getElementById('time');
const msgEl = document.getElementById('msg');
const win = document.getElementById('win');
const menu = document.getElementById('menu');
const res = document.getElementById('res');
const cheatEl = document.getElementById('cheat');
const homeBtn = document.getElementById('homeBtn');
const musicBtn = document.getElementById('musicBtn');
const menuSoundBtn = document.getElementById('menuSoundBtn');
const testReportEl = document.getElementById('testReport');
const customLoadBtn = document.getElementById('customLoadBtn');
const customPlayBtn = document.getElementById('customPlayBtn');
const customSelect = document.getElementById('customSelect');
const customFilesInput = document.getElementById('customFilesInput');

const LEVELS = 50;
const BASE_H = 1700;
const p = {x:120,y:920,w:34,h:44,vx:0,vy:0,f:1,g:false,c:0,jb:0,dc:0,ds:0,dd:1};
const ph = {spd:360,acc:3000,fr:3400,gr:2100,j:810,mf:1250,ct:.09,jbt:.12,dh:860,dd:.16,cd:.72};

let keys = new Set();
let inp = {l:false,r:false,j:false,d:false};
let cam = {x:0,y:0};
let cur = null;
let level = 0;
let deaths = 0;
let runStart = performance.now();
let done = false;
let started = false;
let cheat = false;
let cheatHold = 0;
let lastTaunt = 0;
let msgTo = 0;
let levelLockUntil = 0;
let dpr = 1;
let bg = document.createElement('canvas');
const ai = {enabled:false, route:null, step:0, stuck:0, lastX:0, lastY:0, jumpCd:0, tested:false, failed:[], memory:{}};
let gameMode = 'campaign';
let customLevels = [];
let customIndex = 0;

const themes = [
  {name:'Орбита Титана',top:'#020611',mid:'#0b1b36',bot:'#172e4b',neb:'#2c557f',planet:'#8eb8ff',sun:'#7fd3ff'},
  {name:'Багровая туманность',top:'#12040a',mid:'#300914',bot:'#58172a',neb:'#9a2c52',planet:'#ff9dad',sun:'#ff6f83'},
  {name:'Ледяной космос',top:'#04121f',mid:'#0b2f45',bot:'#134b65',neb:'#4f95b7',planet:'#d3f4ff',sun:'#9de6ff'},
  {name:'Пепельная война',top:'#080a11',mid:'#191d28',bot:'#2f3744',neb:'#596173',planet:'#d6dee9',sun:'#91aac9'},
  {name:'Реликт Империи',top:'#04070c',mid:'#0c1322',bot:'#171f33',neb:'#274572',planet:'#bfd4ff',sun:'#9db4ff'},
  {name:'Темная сингулярность',top:'#0b0613',mid:'#200934',bot:'#371355',neb:'#6f2fb2',planet:'#e2b8ff',sun:'#b77bff'}
];

const svg = s => { const i = new Image(); i.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(s); return i; };
const art = {
  spike: svg("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 220 60'><g fill='#b4bfd4'><path d='M0 60 L16 8 L32 60Z'/><path d='M28 60 L44 6 L60 60Z'/><path d='M56 60 L72 10 L88 60Z'/><path d='M84 60 L100 6 L116 60Z'/><path d='M112 60 L128 8 L144 60Z'/><path d='M140 60 L156 6 L172 60Z'/><path d='M168 60 L184 10 L200 60Z'/><path d='M196 60 L210 8 L220 60Z'/></g></svg>"),
  saw: svg("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 160'><defs><radialGradient id='m' cx='50%' cy='50%' r='50%'><stop offset='0' stop-color='#f1f6ff'/><stop offset='1' stop-color='#8a96ab'/></radialGradient></defs><g transform='translate(80,80)'><path d='M0,-72 L10,-52 L32,-64 L28,-40 L52,-38 L36,-20 L58,-8 L34,2 L44,24 L20,20 L16,46 L0,28 L-16,46 L-20,20 L-44,24 L-34,2 L-58,-8 L-36,-20 L-52,-38 L-28,-40 L-32,-64 L-10,-52 Z' fill='url(#m)'/><circle r='27' fill='#5f6f83'/><circle r='10' fill='#d9e6f8'/></g></svg>"),
  emitter: svg("<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 80 220'><rect x='18' y='0' width='44' height='220' rx='12' fill='#111827'/><rect x='30' y='8' width='20' height='204' rx='8' fill='#2c374a'/></svg>")
};

const shipSheet = new Image();
const robotSheet = new Image();
let shipSheetReady = false;
let robotSheetReady = false;
shipSheet.onload = () => shipSheetReady = true;
robotSheet.onload = () => robotSheetReady = true;
shipSheet.src = 'assets/ui/kr.png';
robotSheet.src = 'assets/ui/rb.png';

const SHIP_FRAMES = [
  {x:40,y:100,w:500,h:340},
  {x:540,y:110,w:430,h:300},
  {x:150,y:500,w:730,h:430}
];
const ROBOT_FRAMES = [
  {x:40,y:260,w:280,h:660},
  {x:300,y:210,w:430,h:770},
  {x:700,y:300,w:300,h:630}
];

const cl = (v,a,b) => Math.max(a,Math.min(b,v));
const hit = (a,b) => a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
const chr = (x,y,r,o) => {
  const nx = cl(x,o.x,o.x+o.w), ny = cl(y,o.y+0,o.y+o.h);
  const dx = x-nx, dy = y-ny;
  return dx*dx + dy*dy <= r*r;
};
const rr = (x,y,w,h,r) => {
  const q = Math.min(r,w*.5,h*.5);
  cx.beginPath();
  cx.moveTo(x+q,y); cx.lineTo(x+w-q,y); cx.quadraticCurveTo(x+w,y,x+w,y+q);
  cx.lineTo(x+w,y+h-q); cx.quadraticCurveTo(x+w,y+h,x+w-q,y+h);
  cx.lineTo(x+q,y+h); cx.quadraticCurveTo(x,y+h,x,y+h-q);
  cx.lineTo(x,y+q); cx.quadraticCurveTo(x,y,x+q,y);
  cx.closePath();
};
const rng = s => () => ((s = (s * 1664525 + 1013904223) >>> 0) / 4294967296);

function showMsg(t, ms=1800){
  msgEl.textContent = t;
  msgEl.classList.add('show');
  clearTimeout(msgTo);
  msgTo = setTimeout(() => msgEl.classList.remove('show'), ms);
}

function buildSky(){
  const w = innerWidth, h = innerHeight;
  bg.width = Math.floor(w*dpr);
  bg.height = Math.floor(h*dpr);
  const s = bg.getContext('2d');
  s.setTransform(dpr,0,0,dpr,0,0);

  const th = cur.theme;
  const g = s.createLinearGradient(0,0,0,h);
  g.addColorStop(0, th.top);
  g.addColorStop(0.48, th.mid);
  g.addColorStop(1, th.bot);
  s.fillStyle = g;
  s.fillRect(0,0,w,h);

  for(let i=0;i<80;i++){
    const x = (i * 211) % w;
    const y = (i * 127) % (h * 0.78);
    const a = (i % 7) / 12 + 0.12;
    s.fillStyle = 'rgba(225,238,255,'+a.toFixed(3)+')';
    s.fillRect(x, y, i % 3 ? 2 : 1, i % 4 ? 2 : 1);
  }

  for(let i=0;i<4;i++){
    const rr = parseInt(th.neb.slice(1,3),16);
    const gg = parseInt(th.neb.slice(3,5),16);
    const bb = parseInt(th.neb.slice(5,7),16);
    s.fillStyle = 'rgba('+rr+','+gg+','+bb+','+(0.06+i*0.025)+')';
    s.beginPath();
    s.ellipse((i*370+120)%w, 120+i*80, 250-i*15, 80+i*8, 0, 0, Math.PI*2);
    s.fill();
  }

  s.globalAlpha = 0.32;
  const p1 = s.createRadialGradient(w-220, 172, 12, w-220, 172, 118);
  p1.addColorStop(0,'#d6e8ff');
  p1.addColorStop(.56,th.planet);
  p1.addColorStop(1,'#1f3152');
  s.fillStyle = p1;
  s.beginPath();
  s.arc(w-220, 172, 112, 0, Math.PI*2);
  s.fill();

  s.globalAlpha = .22;
  s.fillStyle = '#8bb0ff';
  s.beginPath();
  s.arc(w-78, 88, 34, 0, Math.PI*2);
  s.fill();

  s.globalAlpha = .18;
  s.fillStyle = '#10192c';
  s.beginPath();
  s.ellipse(w-246, 188, 88, 24, -0.35, 0, Math.PI*2);
  s.fill();

  s.globalAlpha = .34;
  s.strokeStyle = 'rgba(230,245,255,0.34)';
  s.lineWidth = 2.5;
  s.beginPath();
  s.ellipse(w-225, 170, 152, 38, -0.25, 0, Math.PI*2);
  s.stroke();

  s.globalAlpha = .16;
  s.strokeStyle = 'rgba(255,120,120,0.6)';
  s.lineWidth = 1.2;
  s.beginPath();
  s.moveTo(w-300, 0);
  s.lineTo(w-120, h);
  s.stroke();

  const sun = s.createRadialGradient(110, 110, 20, 110, 110, 190);
  sun.addColorStop(0,'rgba(255,235,210,0.38)');
  sun.addColorStop(1,'rgba(255,170,120,0)');
  s.fillStyle = sun;
  s.fillRect(0,0,w,h);
  s.globalAlpha = 1;
}

function resize(){
  dpr = Math.min(devicePixelRatio || 1, 1.25);
  cv.width = Math.floor(innerWidth*dpr);
  cv.height = Math.floor(innerHeight*dpr);
  cx.setTransform(dpr,0,0,dpr,0,0);
  if(cur) buildSky();
}

function spawnPlatform(arr, x, y, w, type='solid'){
  const p0 = {x,y,w,h:22,type,timer:0,gone:false,restore:0};
  arr.push(p0);
  return p0;
}

function genForwardLevel(i){
  const r = rng(3101 + i*517);
  const width = 4300 + i*180;
  const height = BASE_H;
  const start = {x:120, y:height-370};
  const platforms = [];
  spawnPlatform(platforms, 0, height-250, 520, 'solid');

  let prev = platforms[0];
  let cursor = prev.x + prev.w;
  const segs = 18 + Math.floor(i*0.7);
  const hard = i > 24;
  const maxRise = hard ? 128 : 112;

  for(let n=0;n<segs;n++){
    const gap = 104 + Math.floor(r() * (hard ? 124 : 102));
    const w = 128 + Math.floor(r()*90);
    const x = cursor + gap;
    let y = prev.y + Math.floor((r() - .5) * (hard ? 178 : 148));
    y = cl(y, prev.y - maxRise, prev.y + 94);
    y = cl(y, 250, height - 310);
    const type = (n > 3 && (n + i) % (hard ? 4 : 6) === 0) ? 'crumble' : 'solid';
    prev = spawnPlatform(platforms, x, y, w, type);
    cursor = x + w;
  }

  const finalP = spawnPlatform(platforms, width - 430, cl(prev.y - 26, 210, height - 330), 360, 'solid');
  const goal = {x:finalP.x + finalP.w - 86, y:finalP.y - 84, w:64, h:84};

  const spikes = [];
  const groundBands = 5 + Math.floor(i/5);
  for(let g=0; g<groundBands; g++){
    const sx = 980 + Math.floor(g*(width-1900)/Math.max(1,groundBands));
    spikes.push({x:sx,y:height-268,w:70+Math.floor(r()*90),h:18});
  }

  const saws = [];
  const sawCount = 2 + Math.floor(i/8);
  for(let s=0;s<sawCount;s++){
    saws.push({
      cx:1500 + Math.floor(r()*(width-2500)),
      cy:360 + Math.floor(r()*700),
      r:20 + Math.floor(r()*10),
      a:r()<0.5?'x':'y',
      amp:120 + Math.floor(r()*170),
      sp:2 + r()*2,
      ph:r()*6.28
    });
  }

  const lasers = [];
  const laserCount = 2 + Math.floor(i/10);
  for(let l=0;l<laserCount;l++){
    lasers.push({
      x:1700 + Math.floor(r()*(width-2800)),
      y:170 + Math.floor(r()*260),
      w:16,
      h:height-430-Math.floor(r()*220),
      per:1.05 + r()*0.95,
      on:0.46 + r()*0.52,
      ph:r()*1.2
    });
  }

  const stars = [];
  for(let k=0;k<74;k++) stars.push({x:r(),y:r(),a:0.14+r()*0.68,s:1+r()*1.7});
  return {width,height,start,goal,platforms,spikes,saws,lasers,stars,theme:themes[i%themes.length],mode:'forward'};
}

function genVerticalLevel(i){
  const r = rng(9103 + i*733);
  const width = 2600;
  const height = 2500;
  const start = {x:240, y:height-300};
  const platforms = [];
  spawnPlatform(platforms, 0, height-210, 620, 'solid');

  let x = 340;
  let y = height-360;
  const steps = 22 + Math.floor(i/8);
  for(let n=0;n<steps;n++){
    x += Math.floor((r()-.5) * 240);
    x = cl(x, 220, width-560);
    y -= 90 + Math.floor(r()*42);
    const type = (n>3 && n%5===0) ? 'crumble' : 'solid';
    spawnPlatform(platforms, x, y, 190 + Math.floor(r()*90), type);
  }

  const top = spawnPlatform(platforms, cl(x+40, 150, width-450), 170, 320, 'solid');
  const goal = {x:top.x + top.w - 86, y:top.y - 84, w:64, h:84};

  const spikes = [];
  for(let n=0;n<9;n++){
    const px = 680 + Math.floor(r()*(width-1300));
    const py = 420 + Math.floor(r()*(height-920));
    spikes.push({x:px,y:py,w:54+Math.floor(r()*70),h:18});
  }

  const saws = [];
  for(let s=0;s<5;s++){
    saws.push({
      cx:460 + Math.floor(r()*(width-900)),
      cy:340 + Math.floor(r()*(height-700)),
      r:22 + Math.floor(r()*9),
      a:r()<0.5?'x':'y',
      amp:90 + Math.floor(r()*140),
      sp:2.4 + r()*1.9,
      ph:r()*6.28
    });
  }

  const lasers = [];
  for(let l=0;l<4;l++){
    lasers.push({
      x:520 + Math.floor(r()*(width-980)),
      y:170 + Math.floor(r()*220),
      w:16,
      h:height-380-Math.floor(r()*260),
      per:1.1 + r()*0.8,
      on:0.5 + r()*0.46,
      ph:r()*1.3
    });
  }

  const stars = [];
  for(let k=0;k<92;k++) stars.push({x:r(),y:r(),a:0.12+r()*0.68,s:1+r()*1.5});
  return {width,height,start,goal,platforms,spikes,saws,lasers,stars,theme:themes[(i+2)%themes.length],mode:'vertical'};
}

function genReverseLevel(i){
  const r = rng(12997 + i*997);
  const width = 6200;
  const height = BASE_H;
  const start = {x:width-230, y:height-370};
  const platforms = [];
  spawnPlatform(platforms, width-640, height-250, 640, 'solid');

  let prev = platforms[0];
  let cursor = prev.x;
  const segs = 36;
  for(let n=0;n<segs;n++){
    const gap = 96 + Math.floor(r()*118);
    const w = 136 + Math.floor(r()*94);
    const x = cursor - gap - w;
    let y = prev.y + Math.floor((r()-.5)*166);
    y = cl(y, prev.y-116, prev.y+102);
    y = cl(y, 230, height-310);
    const type = (n>2 && n%4===0) ? 'crumble' : 'solid';
    prev = spawnPlatform(platforms, x, y, w, type);
    cursor = x;
  }

  const finalP = spawnPlatform(platforms, 56, cl(prev.y-12,210,height-330), 350, 'solid');
  const goal = {x:78, y:finalP.y - 84, w:64, h:84};

  const spikes = [];
  for(let n=0;n<12;n++){
    const x = 430 + Math.floor(r()*(width-1300));
    spikes.push({x,y:height-268,w:70+Math.floor(r()*100),h:18});
  }

  const saws = [];
  for(let s=0;s<7;s++){
    saws.push({
      cx:560 + Math.floor(r()*(width-1100)),
      cy:260 + Math.floor(r()*780),
      r:21 + Math.floor(r()*11),
      a:r()<0.5?'x':'y',
      amp:130 + Math.floor(r()*190),
      sp:2.5 + r()*2,
      ph:r()*6.28
    });
  }

  const lasers = [];
  for(let l=0;l<5;l++){
    lasers.push({
      x:650 + Math.floor(r()*(width-1300)),
      y:150 + Math.floor(r()*230),
      w:16,
      h:height-430-Math.floor(r()*220),
      per:1.03 + r()*0.88,
      on:0.53 + r()*0.4,
      ph:r()*1.3
    });
  }

  const stars = [];
  for(let k=0;k<88;k++) stars.push({x:r(),y:r(),a:0.14+r()*0.68,s:1+r()*1.7});
  return {width,height,start,goal,platforms,spikes,saws,lasers,stars,theme:themes[4],mode:'reverse'};
}

function validateLevel(data){
  if(!data.platforms.length) return false;
  let prev = {x:data.start.x,y:data.start.y,w:100,h:20};
  for(const t of data.platforms.slice(1)){
    const dx = t.x - prev.x;
    const dy = t.y - prev.y;
    if(Math.abs(dx) > 320) return false;
    if(dy < -170 || dy > 130) return false;
    prev = t;
  }
  return true;
}

function levelGen(i){
  let tries = 0;
  while(tries < 6){
    let candidate;
    if(i === LEVELS-1) candidate = genReverseLevel(i);
    else if(i % 12 === 5 || i % 12 === 9) candidate = genVerticalLevel(i);
    else candidate = genForwardLevel(i);
    if(validateLevel(candidate)) return candidate;
    tries++;
  }
  return i === LEVELS-1 ? genReverseLevel(i) : genForwardLevel(i);
}

function hashStr(s){
  let h = 2166136261;
  for(let i=0;i<s.length;i++) h = (h ^ s.charCodeAt(i)) * 16777619;
  return (h >>> 0) || 1;
}

function normalizeCustomLevel(raw, fallbackName){
  const width = Math.max(800, Number(raw?.width) || 4800);
  const height = Math.max(700, Number(raw?.height) || BASE_H);
  const themeObj = (raw?.theme && typeof raw.theme === 'object' && raw.theme.top) ? raw.theme : null;
  const themeIdx = cl(Number(raw?.meta?.theme ?? raw?.theme ?? 0), 0, themes.length - 1);
  const name = String(raw?.meta?.name || fallbackName || 'custom-level');
  const rr = rng(hashStr(name));
  const stars = [];
  for(let i=0;i<70;i++) stars.push({x:rr(),y:rr(),a:0.15+rr()*0.6,s:1+rr()*1.5});

  const platforms = Array.isArray(raw?.platforms) ? raw.platforms.map((p)=>({
    x:Number(p.x)||0,
    y:Number(p.y)||0,
    w:Math.max(20, Number(p.w)||120),
    h:Math.max(8, Number(p.h)||22),
    type:p.type==='crumble'?'crumble':'solid',
    timer:0,
    gone:false,
    restore:0
  })) : [];

  const spikes = Array.isArray(raw?.spikes) ? raw.spikes.map((s)=>({
    x:Number(s.x)||0,
    y:Number(s.y)||0,
    w:Math.max(20, Number(s.w)||60),
    h:Math.max(8, Number(s.h)||18)
  })) : [];

  const saws = Array.isArray(raw?.saws) ? raw.saws.map((s)=>({
    cx:Number(s.cx ?? s.x) || 0,
    cy:Number(s.cy ?? s.y) || 0,
    r:Math.max(8, Number(s.r)||22),
    a:s.a==='y'?'y':'x',
    amp:Math.max(10, Number(s.amp)||120),
    sp:Math.max(0.1, Number(s.sp)||2.4),
    ph:Number(s.ph)||0
  })) : [];

  const lasers = Array.isArray(raw?.lasers) ? raw.lasers.map((l)=>({
    x:Number(l.x)||0,
    y:Number(l.y)||0,
    w:Math.max(6, Number(l.w)||16),
    h:Math.max(20, Number(l.h)||220),
    per:Math.max(0.2, Number(l.per)||1.2),
    on:Math.max(0.05, Number(l.on)||0.6),
    ph:Number(l.ph)||0
  })) : [];

  return {
    width,
    height,
    start:{x:Number(raw?.start?.x)||120,y:Number(raw?.start?.y)||(height-370)},
    goal:{x:Number(raw?.goal?.x)||(width-150),y:Number(raw?.goal?.y)||(height-340),w:Math.max(20,Number(raw?.goal?.w)||64),h:Math.max(20,Number(raw?.goal?.h)||84)},
    platforms: platforms.length ? platforms : [{x:0,y:height-250,w:520,h:22,type:'solid',timer:0,gone:false,restore:0}],
    spikes,
    saws,
    lasers,
    stars,
    theme: themeObj || themes[themeIdx],
    mode:'custom',
    customName:name
  };
}

function refreshCustomSelect(){
  customSelect.innerHTML = '';
  if(!customLevels.length){
    const o = document.createElement('option');
    o.value = '';
    o.textContent = 'Нет загруженных';
    customSelect.appendChild(o);
    return;
  }
  customLevels.forEach((lvl, idx)=>{
    const o = document.createElement('option');
    o.value = String(idx);
    const name = lvl?.meta?.name || lvl?.customName || ('custom-'+(idx+1));
    o.textContent = (idx+1) + '. ' + name;
    customSelect.appendChild(o);
  });
}

function findSupportPlatformIndex(data, x, yRef){
  let best = -1;
  let bestD = 1e9;
  for(let i=0;i<data.platforms.length;i++){
    const t = data.platforms[i];
    if(x < t.x-30 || x > t.x+t.w+30) continue;
    const d = t.y - yRef;
    if(d < -200 || d > 240) continue;
    const ad = Math.abs(d);
    if(ad < bestD){ bestD = ad; best = i; }
  }
  return best;
}

function canJumpBetween(a,b){
  const ax = a.x + a.w*0.5;
  const bx = b.x + b.w*0.5;
  const dx = bx - ax;
  const dy = b.y - a.y;
  if(dy < -230 || dy > 290) return false;
  let maxDx = 410;
  if(dy < -120) maxDx = 300;
  else if(dy < -50) maxDx = 340;
  else if(dy > 120) maxDx = 470;
  return Math.abs(dx) <= maxDx;
}

function buildLevelPath(data){
  const startIdx = findSupportPlatformIndex(data, data.start.x + 18, data.start.y + p.h);
  const goalIdx = findSupportPlatformIndex(data, data.goal.x + data.goal.w*0.5, data.goal.y + data.goal.h + 30);
  if(startIdx < 0 || goalIdx < 0) return null;

  const n = data.platforms.length;
  const prev = new Array(n).fill(-1);
  const used = new Array(n).fill(false);
  const q = [startIdx];
  used[startIdx] = true;

  while(q.length){
    const curIdx = q.shift();
    if(curIdx === goalIdx) break;
    const from = data.platforms[curIdx];
    for(let j=0;j<n;j++){
      if(used[j]) continue;
      const to = data.platforms[j];
      if(!canJumpBetween(from,to)) continue;
      used[j] = true;
      prev[j] = curIdx;
      q.push(j);
    }
  }

  if(!used[goalIdx]) return null;
  const path = [];
  let t = goalIdx;
  while(t !== -1){
    path.push(t);
    t = prev[t];
  }
  path.reverse();
  return path;
}

function runPathfinderTests(){
  const failed = [];
  for(let i=0;i<LEVELS;i++){
    const data = levelGen(i);
    const path = buildLevelPath(data);
    if(!path || path.length < 2) failed.push(i+1);
  }
  ai.tested = true;
  ai.failed = failed;
  if(failed.length){
    testReportEl.textContent = 'Pathfinder тест: проблемы на уровнях ' + failed.slice(0,8).join(', ') + (failed.length>8?' ...':'');
  } else {
    testReportEl.textContent = 'Pathfinder тест: все 50/50 сидов проходимы';
  }
  return failed.length === 0;
}

function aiProfile(levelIndex){
  if(!ai.memory[levelIndex]){
    ai.memory[levelIndex] = {jumpBias:0,dashBias:0,stuckBias:0,deaths:0,success:0};
  }
  return ai.memory[levelIndex];
}

function aiLearnFromDeath(){
  if(!ai.enabled) return;
  const m = aiProfile(level);
  m.deaths++;
  m.jumpBias = Math.min(0.65, m.jumpBias + 0.04);
  if(m.deaths % 2 === 0) m.dashBias = Math.min(0.65, m.dashBias + 0.05);
  if(m.deaths % 3 === 0) m.stuckBias = Math.min(0.8, m.stuckBias + 0.08);
}

function aiLearnFromSuccess(){
  const m = aiProfile(level);
  m.success++;
  m.jumpBias = Math.max(0, m.jumpBias - 0.015);
  m.dashBias = Math.max(0, m.dashBias - 0.02);
  m.stuckBias = Math.max(0, m.stuckBias - 0.03);
}

function resetAiRoute(){
  ai.route = buildLevelPath(cur) || [];
  ai.step = ai.route.length > 1 ? 1 : 0;
  ai.stuck = 0;
  ai.lastX = p.x;
  ai.lastY = p.y;
  ai.jumpCd = 0;
}

function loadLevel(i, withTransition){
  if(gameMode === 'custom' && customLevels.length){
    const src = customLevels[cl(customIndex,0,customLevels.length-1)];
    cur = normalizeCustomLevel(src, src?.meta?.name || src?.customName || 'custom-level');
  } else {
    cur = levelGen(i);
  }
  p.x = cur.start.x;
  p.y = cur.start.y;
  p.vx = 0;
  p.vy = 0;
  p.c = 0;
  p.jb = 0;
  p.dc = 0;
  p.ds = 0;
  buildSky();
  if(ai.enabled) resetAiRoute();
  levelEl.textContent = gameMode === 'custom' ? ('Кастом: ' + (cur.customName || ('#'+(customIndex+1)))) : ('Уровень ' + (i+1) + '/' + LEVELS);
  if(withTransition){
    levelLockUntil = performance.now() + 900;
    showMsg(gameMode === 'custom' ? 'ПЕРЕЗАПУСК КАСТОМНОГО' : ('ПЕРЕХОД НА УРОВЕНЬ ' + (i+1)), 950);
  }
  setTimeout(() => {
    const modeText = cur.mode === 'custom' ? (cur.customName || 'Кастомный уровень') : (cur.mode === 'vertical' ? 'ВЕРТИКАЛЬНЫЙ ПОДЪЕМ' : cur.mode === 'reverse' ? 'ИДИ НАЛЕВО' : cur.theme.name);
    showMsg((gameMode === 'custom' ? 'ТЕСТ: ' : ('УРОВЕНЬ ' + (i+1) + ': ')) + modeText, 1900);
  }, withTransition ? 420 : 0);
}

function die(){
  if(done || !started) return;
  aiLearnFromDeath();
  sfx('death');
  taunt();
  deaths++;
  p.x = cur.start.x;
  p.y = cur.start.y;
  p.vx = 0;
  p.vy = 0;
  p.c = 0;
  p.jb = 0;
  if(ai.enabled) resetAiRoute();
}

function beginRun(resetStats, watchAi){
  if(resetStats){
    deaths = 0;
    if(gameMode === 'campaign') level = 0;
  }
  ai.enabled = !!watchAi;
  inp.l = false;
  inp.r = false;
  inp.j = false;
  inp.d = false;
  cheat = false;
  cheatHold = 0;
  cheatEl.style.display = 'none';
  done = false;
  started = true;
  runStart = performance.now();
  levelLockUntil = 0;
  loadLevel(level, false);
  if(ai.enabled && (!ai.route || ai.route.length < 2)) showMsg('ИИ: демо-маршрут к цели', 1600);
  win.classList.remove('show');
}

function bind(id,d,u){
  const b = document.getElementById(id);
  const on = e => { e.preventDefault(); audioOn(); b.classList.add('on'); d(); };
  const off = e => { e.preventDefault(); b.classList.remove('on'); u(); };
  b.addEventListener('touchstart',on,{passive:false});
  b.addEventListener('mousedown',on);
  ['touchend','touchcancel','mouseup','mouseleave'].forEach(ev => b.addEventListener(ev,off));
}

bind('l',()=>inp.l=true,()=>inp.l=false);
bind('r',()=>inp.r=true,()=>inp.r=false);
bind('j',()=>inp.j=true,()=>{});
bind('d',()=>inp.d=true,()=>{});

addEventListener('keydown',e=>{
  audioOn();
  keys.add(e.code);
  if(['ArrowUp','Space','KeyW'].includes(e.code)) inp.j = true;
  if(['ShiftLeft','ShiftRight','KeyK'].includes(e.code)) inp.d = true;
});
addEventListener('keyup',e=>keys.delete(e.code));
addEventListener('resize',resize);

document.getElementById('retry').onclick = () => beginRun(true, ai.enabled);
document.getElementById('playBtn').onclick = () => {
  audioOn();
  gameMode = 'campaign';
  beginRun(true, false);
  menu.classList.remove('show');
};
document.getElementById('aiPlayBtn').onclick = () => {
  audioOn();
  gameMode = 'campaign';
  runPathfinderTests();
  beginRun(true, true);
  showMsg('ДЕМО РЕЖИМ: ИИ ИГРАЕТ', 1700);
  menu.classList.remove('show');
};

customLoadBtn.onclick = () => customFilesInput.click();
customFilesInput.onchange = async (ev) => {
  const files = Array.from(ev.target.files || []);
  if(!files.length) return;
  const loaded = [];
  for(const f of files){
    try{
      const text = await f.text();
      const parsed = JSON.parse(text);
      parsed.meta = parsed.meta || {};
      if(!parsed.meta.name) parsed.meta.name = f.name.replace(/\.json$/i,'');
      loaded.push(parsed);
    }catch{}
  }
  if(loaded.length){
    customLevels = loaded;
    customIndex = 0;
    refreshCustomSelect();
    testReportEl.textContent = 'Кастомные уровни: загружено ' + loaded.length;
    showMsg('Загружено кастомных уровней: ' + loaded.length, 1700);
  } else {
    showMsg('Не удалось прочитать JSON уровни', 1700);
  }
  customFilesInput.value = '';
};

customPlayBtn.onclick = () => {
  if(!customLevels.length){
    showMsg('Сначала загрузи JSON уровни', 1500);
    return;
  }
  audioOn();
  gameMode = 'custom';
  customIndex = cl(parseInt(customSelect.value || '0', 10), 0, customLevels.length - 1);
  beginRun(true, false);
  menu.classList.remove('show');
};

function goHome(){
  started = false;
  done = false;
  ai.enabled = false;
  inp.l = false;
  inp.r = false;
  inp.j = false;
  inp.d = false;
  win.classList.remove('show');
  menu.classList.add('show');
  showMsg('ГЛАВНОЕ МЕНЮ', 1100);
}

homeBtn.onclick = goHome;

let actx = null, aReady = false, musicOn = false, musicIdx = 0, musicEl = new Audio(), musicGain = null, musicEnabled = true;
const configuredTracks = (window.MY_MUSIC && Array.isArray(window.MY_MUSIC.tracks)) ? window.MY_MUSIC.tracks : [];
const configuredTaunts = (window.MY_MUSIC && Array.isArray(window.MY_MUSIC.taunts)) ? window.MY_MUSIC.taunts : [];
const tauntClips = configuredTaunts.map(src => new Audio(src));
for(const a of tauntClips){ a.preload='auto'; a.volume=.92; }

function syncMusicBtn(){
  const text = 'ЗВУК: ' + (musicEnabled ? 'ВКЛ' : 'ВЫКЛ');
  musicBtn.textContent = 'МУЗЫКА: ' + (musicEnabled ? 'ВКЛ' : 'ВЫКЛ');
  musicBtn.classList.toggle('off', !musicEnabled);
  menuSoundBtn.textContent = text;
  menuSoundBtn.classList.toggle('off', !musicEnabled);
}

function stopMusic(){
  musicOn = false;
  musicEl.pause();
  musicEl.currentTime = 0;
  if(musicGain){
    try{ musicGain.disconnect(); }catch{}
    musicGain = null;
  }
}

function startSynthMusic(){
  if(!actx || !musicEnabled || musicOn) return;
  musicOn = true;
  const g = actx.createGain();
  g.gain.value = .022;
  g.connect(actx.destination);
  musicGain = g;
  const t = actx.currentTime;
  const mk = (f,ty) => { const o=actx.createOscillator(); o.type=ty; o.frequency.setValueAtTime(f,t); o.connect(g); o.start(); return o; };
  const a = mk(138.59,'triangle');
  const b = mk(207.65,'sine');
  const c = mk(277.18,'triangle');
  const l = actx.createOscillator();
  const lg = actx.createGain();
  l.frequency.value = .18;
  lg.gain.value = 12;
  l.connect(lg);
  lg.connect(a.frequency);
  lg.connect(b.frequency);
  lg.connect(c.frequency);
  l.start();
}

function startMusic(){
  if(!musicEnabled || musicOn) return;
  if(configuredTracks.length){
    musicOn = true;
    musicEl.volume = .42;
    musicEl.preload = 'auto';
    musicEl.loop = false;
    musicEl.src = configuredTracks[musicIdx % configuredTracks.length];
    musicEl.play().catch(()=>{});
    musicEl.onended = () => {
      if(!musicEnabled) return;
      musicIdx++;
      musicEl.src = configuredTracks[musicIdx % configuredTracks.length];
      musicEl.play().catch(()=>{});
    };
    return;
  }
  startSynthMusic();
}

function audioOn(){
  if(!actx){
    const C = window.AudioContext || window.webkitAudioContext;
    if(!C) return;
    actx = new C();
  }
  if(actx.state === 'suspended') actx.resume();
  aReady = true;
  startMusic();
}

function toggleSound(){
  audioOn();
  musicEnabled = !musicEnabled;
  if(!musicEnabled) stopMusic();
  else startMusic();
  syncMusicBtn();
}

musicBtn.onclick = toggleSound;
menuSoundBtn.onclick = toggleSound;
syncMusicBtn();

function sfx(t){
  if(!actx || !aReady) return;
  const n=actx.currentTime, o=actx.createOscillator(), g=actx.createGain();
  o.connect(g); g.connect(actx.destination);
  if(t==='jump'){
    o.type='triangle'; o.frequency.setValueAtTime(280,n); o.frequency.exponentialRampToValueAtTime(520,n+.09);
    g.gain.setValueAtTime(.0001,n); g.gain.exponentialRampToValueAtTime(.05,n+.01); g.gain.exponentialRampToValueAtTime(.0001,n+.11);
    o.start(n); o.stop(n+.12); return;
  }
  if(t==='dash'){
    o.type='sawtooth'; o.frequency.setValueAtTime(145,n); o.frequency.exponentialRampToValueAtTime(92,n+.12);
    g.gain.setValueAtTime(.0001,n); g.gain.exponentialRampToValueAtTime(.07,n+.01); g.gain.exponentialRampToValueAtTime(.0001,n+.14);
    o.start(n); o.stop(n+.15); return;
  }
  if(t==='death'){
    o.type='square'; o.frequency.setValueAtTime(180,n); o.frequency.exponentialRampToValueAtTime(58,n+.3);
    g.gain.setValueAtTime(.0001,n); g.gain.exponentialRampToValueAtTime(.07,n+.01); g.gain.exponentialRampToValueAtTime(.0001,n+.32);
    o.start(n); o.stop(n+.33); return;
  }
  o.type='triangle'; o.frequency.setValueAtTime(330,n); o.frequency.exponentialRampToValueAtTime(660,n+.22);
  g.gain.setValueAtTime(.0001,n); g.gain.exponentialRampToValueAtTime(.06,n+.02); g.gain.exponentialRampToValueAtTime(.0001,n+.28);
  o.start(n); o.stop(n+.29);
}

function taunt(){
  const now = performance.now();
  if(now - lastTaunt < 1500) return;
  lastTaunt = now;
  if(tauntClips.length){
    const pick = tauntClips[Math.floor(Math.random()*tauntClips.length)];
    try{ pick.currentTime = 0; pick.play().catch(()=>{}); }catch{}
  }
}

function solidPlatforms(){
  return cur.platforms.filter(t => t.type !== 'crumble' || !t.gone);
}

function applyAiControls(dt){
  if(!ai.enabled) return;
  const mem = aiProfile(level);

  inp.l = false;
  inp.r = false;
  ai.jumpCd -= dt;

  if(ai.route && ai.step < ai.route.length){
    const t = cur.platforms[ai.route[ai.step]];
    if(t){
      const cx = p.x + p.w*0.5;
      const fy = p.y + p.h;
      const onThis = cx > t.x-8 && cx < t.x+t.w+8 && Math.abs(fy - t.y) < 12;
      if(onThis) ai.step++;
    }
  }

  const targetPlat = (ai.route && ai.step < ai.route.length) ? cur.platforms[ai.route[ai.step]] : null;
  const tx = targetPlat ? targetPlat.x + targetPlat.w*0.5 : cur.goal.x + cur.goal.w*0.5;
  const ty = targetPlat ? targetPlat.y : cur.goal.y + cur.goal.h;
  const cx = p.x + p.w*0.5;
  const fy = p.y + p.h;
  const dx = tx - cx;
  const dy = ty - fy;

  inp.l = dx < -18;
  inp.r = dx > 18;

  const grounded = p.g || p.c > 0;
  if(grounded && ai.jumpCd <= 0){
    const jumpTuning = mem.jumpBias * 65;
    const dashTuning = mem.dashBias * 90;
    const needBigJump = dy < (-52 + jumpTuning);
    const needGapJump = Math.abs(dx) > (130 - dashTuning * 0.45) && dy < (78 + jumpTuning * 0.7);
    const closeJump = dy < (-24 + jumpTuning) && Math.abs(dx) < (190 + dashTuning * 0.35);
    if(needBigJump || needGapJump || closeJump){
      inp.j = true;
      ai.jumpCd = 0.16;
      if(p.dc <= 0 && (Math.abs(dx) > (170 - dashTuning) || dy < (-105 + jumpTuning))) inp.d = true;
    }
  }

  const moved = Math.hypot(p.x - ai.lastX, p.y - ai.lastY);
  ai.lastX = p.x;
  ai.lastY = p.y;
  if(moved < 3) ai.stuck += dt;
  else ai.stuck = 0;

  if(ai.stuck > (1.0 - Math.min(mem.stuckBias * 0.35, 0.3)) && grounded){
    inp.j = true;
    if(p.dc <= 0) inp.d = true;
  }
  if(ai.stuck > (2.4 - Math.min(mem.stuckBias * 0.6, 0.55))){
    ai.stuck = 0;
    if(ai.route && ai.step + 1 < ai.route.length) ai.step++;
  }
}

function update(dt, et){
  for(const t of cur.platforms){
    if(t.type==='crumble' && t.gone){
      t.restore -= dt;
      if(t.restore <= 0){ t.gone=false; t.timer=0; }
    }
  }

  if(ai.enabled) applyAiControls(dt);

  const left = inp.l || keys.has('ArrowLeft') || keys.has('KeyA');
  const right = inp.r || keys.has('ArrowRight') || keys.has('KeyD');

  if(!cheat && left && right){
    cheatHold += dt;
    if(cheatHold >= 5){
      cheat = true;
      cheatEl.style.display = 'block';
      showMsg('ЧИТКОД АКТИВЕН', 1600);
    }
  } else if(!cheat) cheatHold = 0;

  const m = (right ? 1 : 0) - (left ? 1 : 0);
  if(m) p.f = m;
  if(inp.j) p.jb = ph.jbt;

  if(inp.d && p.dc <= 0 && !p.ds){
    sfx('dash');
    p.ds = ph.dd;
    p.dd = m || p.f || 1;
    p.vx = p.dd * ph.dh;
    p.vy = 0;
    p.dc = ph.cd;
  }

  inp.j = false;
  inp.d = false;
  p.jb -= dt;
  p.c -= dt;
  p.dc -= dt;

  if(p.ds > 0){
    p.ds -= dt;
    p.vx = p.dd * ph.dh;
    p.vy = 0;
  } else {
    const tgt = m * ph.spd;
    if(m){
      const dir = Math.sign(tgt - p.vx);
      p.vx += dir * ph.acc * dt;
      if((dir > 0 && p.vx > tgt) || (dir < 0 && p.vx < tgt)) p.vx = tgt;
    } else {
      const f = Math.sign(p.vx), a = ph.fr * dt;
      p.vx = Math.abs(p.vx) <= a ? 0 : p.vx - f*a;
    }
    p.vy = Math.min(p.vy + ph.gr*dt, ph.mf);
  }

  if(p.jb > 0 && (p.g || p.c > 0)){
    sfx('jump');
    p.vy = -ph.j;
    p.g = false;
    p.c = 0;
    p.jb = 0;
  }

  p.x += p.vx * dt;
  p.x = cl(p.x,0,cur.width-p.w);

  const prevY = p.y;
  p.y += p.vy * dt;
  p.g = false;

  if(p.vy >= 0){
    const sld = solidPlatforms();
    for(const t of sld){
      const overlapX = p.x + p.w - 4 > t.x && p.x + 4 < t.x + t.w;
      if(!overlapX) continue;
      const prevBottom = prevY + p.h;
      const nextBottom = p.y + p.h;
      if(prevBottom <= t.y + 6 && nextBottom >= t.y){
        p.y = t.y - p.h;
        p.vy = 0;
        p.g = true;
        p.c = ph.ct;
        if(t.type === 'crumble'){
          t.timer += dt;
          if(t.timer > .28){
            t.gone = true;
            t.restore = 2.4;
          }
        }
      }
    }
  }

  if(!p.g){
    for(const t of cur.platforms) if(t.type==='crumble') t.timer = 0;
  }

  if(!cheat){
    for(const s of cur.spikes) if(hit(p,s)) return die();
    for(const s of cur.saws){
      const tt = et*s.sp + s.ph;
      const x = s.cx + (s.a==='x' ? Math.sin(tt)*s.amp : 0);
      const y = s.cy + (s.a==='y' ? Math.sin(tt)*s.amp : 0);
      if(chr(x,y,s.r,p)) return die();
    }
    for(const l of cur.lasers){
      if(((et+l.ph)%l.per)<l.on && hit(p,l)) return die();
    }
  }

  if(p.y > cur.height + 140) return die();

  if(hit(p, cur.goal)){
    if(ai.enabled) aiLearnFromSuccess();
    if(gameMode === 'campaign' && level < LEVELS-1){
      level++;
      loadLevel(level, true);
      return;
    }
    done = true;
    sfx('win');
    win.classList.add('show');
    res.textContent = 'Смерти: ' + deaths + ' | Время: ' + ((performance.now()-runStart)/1000).toFixed(2) + 'с';
  }
}

function drawShip(x,y,s,alpha,variant){
  if(shipSheetReady){
    const idx = (typeof variant === 'number' ? Math.abs(variant) : Math.abs(Math.floor((x + y) / 37))) % SHIP_FRAMES.length;
    const f = SHIP_FRAMES[idx];
    const dw = f.w * 0.34 * s;
    const dh = f.h * 0.34 * s;
    cx.save();
    cx.globalAlpha = alpha;
    cx.drawImage(shipSheet,f.x,f.y,f.w,f.h,x-dw*0.48,y-dh*0.45,dw,dh);
    cx.restore();
    return;
  }
  cx.save();
  cx.translate(x,y);
  cx.scale(s,s);
  cx.globalAlpha = alpha;
  const hull = cx.createLinearGradient(-70,-10,80,20);
  hull.addColorStop(0,'#8d98ad');
  hull.addColorStop(1,'#2a3240');
  cx.fillStyle = hull;
  cx.beginPath();
  cx.moveTo(-78,6);
  cx.lineTo(56,-16);
  cx.lineTo(88,0);
  cx.lineTo(44,14);
  cx.lineTo(-80,18);
  cx.closePath();
  cx.fill();
  cx.fillStyle = 'rgba(180,208,245,.55)';
  cx.fillRect(-34,-6,26,4);
  cx.fillRect(4,-10,18,3);
  cx.restore();
}

function drawWalker(x,y,scale){
  if(robotSheetReady){
    const idx = Math.abs(Math.floor((x + y) / 43)) % ROBOT_FRAMES.length;
    const f = ROBOT_FRAMES[idx];
    const dw = f.w * 0.22 * scale;
    const dh = f.h * 0.22 * scale;
    cx.save();
    cx.globalAlpha = 0.78;
    cx.drawImage(robotSheet,f.x,f.y,f.w,f.h,x-dw*0.5,y-dh,dw,dh);
    cx.restore();
    return;
  }
  cx.save();
  cx.translate(x,y);
  cx.scale(scale,scale);
  cx.fillStyle = 'rgba(30,36,46,.85)';
  rr(-40,-44,80,28,5); cx.fill();
  rr(30,-40,18,14,3); cx.fill();
  cx.fillRect(-30,-16,7,38); cx.fillRect(-6,-16,7,38); cx.fillRect(16,-16,7,38); cx.fillRect(38,-16,7,38);
  cx.restore();
}

function drawParallax(et){
  const w = innerWidth;
  const h = innerHeight;
  const baseOffset = (level * 277) % (w + 1200);
  const xx = (w + 520) - ((et*34 + baseOffset + cam.x*0.05) % (w + 1200));
  const yy = h * 0.22 + Math.sin(et * 0.22 + level) * 20;
  drawShip(xx, yy, 1.95, .44, level);

  const haze = cx.createLinearGradient(0,h*.62,0,h);
  haze.addColorStop(0,'rgba(40,55,78,0)');
  haze.addColorStop(1,'rgba(18,24,36,0.6)');
  cx.fillStyle = haze;
  cx.fillRect(0,h*.62,w,h*.4);

  const beamX = (w*0.7 + Math.sin(et*0.6)*24);
  const beam = cx.createLinearGradient(beamX,0,beamX,h);
  beam.addColorStop(0,'rgba(255,40,70,0)');
  beam.addColorStop(0.52,'rgba(255,68,84,0.1)');
  beam.addColorStop(1,'rgba(255,50,60,0.02)');
  cx.fillStyle = beam;
  cx.fillRect(beamX-30,0,60,h);
}

function hero(et){
  const bw=54,bh=82,bx=p.x+(p.w-bw)*.5,by=p.y+p.h-bh+3,mv=Math.abs(p.vx)>45,s=(mv?1:.2)*Math.sin(et*14+Math.abs(p.vx)*.01)*.45,tr=p.ds>0?3:mv?1:0;
  cx.save();
  if(p.f<0){cx.translate(bx+bw*.5,0);cx.scale(-1,1);cx.translate(-(bx+bw*.5),0)}
  for(let i=tr;i>=1;i--){cx.globalAlpha=.09+i*.05;body(bx-i*5,by+i*.7,s*.5)}
  cx.globalAlpha=1;
  body(bx,by,s);
  if(mv||p.ds>0){
    const len=p.ds>0?50:30,pulse=.4+Math.abs(Math.sin(et*19))*.45;
    cx.fillStyle='rgba(255,68,68,'+pulse+')';cx.fillRect(bx+bw-4,by+34,len,4);
    cx.fillStyle='rgba(255,194,194,'+(pulse*.8)+')';cx.fillRect(bx+bw-4,by+35,len,2);
  }
  cx.restore();
}

function body(x,y,s){
  const cape=cx.createLinearGradient(x,y+8,x+54,y+82);cape.addColorStop(0,'#131720');cape.addColorStop(1,'#2a3140');
  cx.fillStyle=cape;cx.beginPath();cx.moveTo(x+8,y+26);cx.lineTo(x-4,y+78);cx.lineTo(x+22,y+70);cx.lineTo(x+50,y+82);cx.lineTo(x+42,y+30);cx.closePath();cx.fill();
  cx.save();cx.translate(x+20,y+52);cx.rotate(s);cx.fillStyle='#141b26';rr(-8,0,16,28,6);cx.fill();cx.restore();
  cx.save();cx.translate(x+34,y+52);cx.rotate(-s);cx.fillStyle='#141b26';rr(-8,0,16,28,6);cx.fill();cx.restore();
  cx.fillStyle='#1e2633';rr(x+12,y+24,30,28,8);cx.fill();
  cx.fillStyle='#0f141e';rr(x+18,y+28,18,12,3);cx.fill();
  cx.fillStyle='#7ff6c0';cx.fillRect(x+19,y+29,3,3);
  cx.fillStyle='#74d7ff';cx.fillRect(x+24,y+29,3,3);
  cx.fillStyle='#ff7171';cx.fillRect(x+29,y+29,3,3);
  cx.fillStyle='#111723';cx.beginPath();cx.ellipse(x+27,y+14,12,14,0,0,Math.PI*2);cx.fill();
  cx.fillStyle='#293444';cx.beginPath();cx.ellipse(x+27,y+12,8,8,0,0,Math.PI*2);cx.fill();
  cx.fillStyle='#d5e1f5';cx.fillRect(x+22,y+15,3,2);cx.fillRect(x+29,y+15,3,2);
}

function draw(et){
  const w = innerWidth, h = innerHeight;
  cx.drawImage(bg,0,0,w,h);
  for(const s of cur.stars){
    const x = (s.x*w - et*(6+s.s*5)) % w;
    cx.fillStyle = 'rgba(225,238,255,'+s.a+')';
    cx.fillRect((x+w)%w, s.y*h, 2, 2);
  }

  drawParallax(et);

  cx.save();
  cx.translate(-cam.x,-cam.y);

  cx.fillStyle='#8fd2ff';cx.fillRect(cur.start.x-12,cur.start.y-100,12,100);
  cx.fillStyle='#dff5ff';cx.fillRect(cur.start.x,cur.start.y-92,42,24);
  cx.fillStyle='#0e141d';cx.font='700 22px Trebuchet MS';cx.fillText('A',cur.start.x+12,cur.start.y-74);

  cx.fillStyle='#506882';rr(cur.goal.x,cur.goal.y,cur.goal.w,cur.goal.h,6);cx.fill();
  cx.fillStyle='#b8d7ff';rr(cur.goal.x+18,cur.goal.y+18,28,48,4);cx.fill();
  cx.fillStyle='#102016';cx.fillText('B',cur.goal.x+22,cur.goal.y-10);

  for(const t of cur.platforms){
    if(t.type==='crumble' && t.gone) continue;
    const pg = cx.createLinearGradient(t.x,t.y,t.x,t.y+t.h);
    pg.addColorStop(0,t.type==='crumble'?'#8a7f5d':'#46566d');
    pg.addColorStop(1,t.type==='crumble'?'#58503a':'#2e3948');
    cx.fillStyle = pg;
    rr(t.x,t.y,t.w,t.h,4);
    cx.fill();
    cx.fillStyle='rgba(255,255,255,.14)';
    cx.fillRect(t.x+2,t.y+2,t.w-4,2);
  }

  for(const s of cur.spikes){
    const n = Math.max(1,Math.ceil(s.w/28));
    const sw = s.w/n;
    for(let i=0;i<n;i++) cx.drawImage(art.spike,s.x+i*sw,s.y-1,sw+1,s.h+3);
  }

  for(const l of cur.lasers){
    const a = ((et+l.ph)%l.per) < l.on;
    cx.drawImage(art.emitter,l.x-32,l.y-6,80,l.h+12);
    cx.fillStyle = a ? 'rgba(255,75,75,.88)' : 'rgba(255,75,75,.18)';
    cx.fillRect(l.x,l.y,l.w,l.h);
    if(a){ cx.fillStyle='rgba(255,210,210,.92)'; cx.fillRect(l.x+5,l.y,4,l.h); }
  }

  for(const s of cur.saws){
    const tt = et*s.sp+s.ph;
    const x = s.cx + (s.a==='x'?Math.sin(tt)*s.amp:0);
    const y = s.cy + (s.a==='y'?Math.sin(tt)*s.amp:0);
    cx.strokeStyle='rgba(220,235,255,.24)';
    cx.lineWidth=3;
    cx.beginPath();
    if(s.a==='x'){cx.moveTo(s.cx-s.amp,s.cy);cx.lineTo(s.cx+s.amp,s.cy)}
    else{cx.moveTo(s.cx,s.cy-s.amp);cx.lineTo(s.cx,s.cy+s.amp)}
    cx.stroke();
    cx.save();cx.translate(x,y);cx.rotate(et*3.2);cx.drawImage(art.saw,-s.r,-s.r,s.r*2,s.r*2);cx.restore();
  }

  hero(et);
  cx.restore();
}

let prev = performance.now();
resize();
refreshCustomSelect();
loadLevel(0,false);
runPathfinderTests();

requestAnimationFrame(function loop(now){
  const dt = Math.min(.033,(now-prev)/1000);
  prev = now;
  const et = started ? (now-runStart)/1000 : 0;

  if(started && !done){
    if(now >= levelLockUntil) update(dt,et);
    cam.x = cl(p.x-innerWidth*.34,0,Math.max(0,cur.width-innerWidth));
    cam.y = cl(p.y-innerHeight*.56,0,Math.max(0,cur.height-innerHeight));
  }

  draw(et);
  deathsEl.textContent = 'Смерти: ' + deaths;
  timeEl.textContent = 'Время: ' + et.toFixed(1) + 'с';
  requestAnimationFrame(loop);
});
</script>
</body>
</html>
